<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Nuevo Pedido</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    <script>
        function agregarFila() {
            const fila = document.createElement("div");
            fila.innerHTML = `
                <input name="sku" placeholder="SKU" required oninput="buscarColor(this)">
                <input name="color" placeholder="Color" readonly required>
                <input name="cantidad" type="number" placeholder="Cantidad" required>
                <button type="button" onclick="this.parentNode.remove()">❌</button>
                <br>
            `;
            document.getElementById("productos").appendChild(fila);
        }

        function buscarColor(inputSku) {
            const sku = inputSku.value.trim();
            const colorInput = inputSku.nextElementSibling;
            if (sku.length > 0) {
                fetch(`/obtener_color?sku=${encodeURIComponent(sku)}`)
                    .then(response => response.json())
                    .then(data => {
                        colorInput.value = data.color || '';
                    });
            } else {
                colorInput.value = '';
            }
        }

        window.onload = function () {
            const hoy = new Date().toISOString().split('T')[0];
            document.getElementById("fecha").value = hoy;

            // Agrega autocompletado a la fila inicial
            const skuInput = document.querySelector("#productos input[name='sku']");
            if (skuInput) {
                skuInput.addEventListener("input", function () {
                    buscarColor(this);
                });
            }
        }
    </script>
</head>
<body>
    <h1>Ingresar Nuevo Pedido</h1>

    <form method="POST">
        <label>Canal:
            <select name="canal" required>
                <option value="Mercadolibre">Mercadolibre</option>
                <option value="Bebeglo.cl">Bebeglo.cl</option>
                <option value="Paris">Paris</option>
                <option value="Mercadolibre Flex">Mercadolibre Flex</option>
                <option value="Walmart">Walmart</option>
                <option value="Falabella">Falabella</option>
            </select>
        </label><br>

        <label>Fecha:
            <input type="date" name="fecha" id="fecha" required>
        </label><br><br>

        <h3>Productos</h3>
        <div id="productos">
            <div>
                <input name="sku" placeholder="SKU" required oninput="buscarColor(this)">
                <input name="color" placeholder="Color" readonly required>
                <input name="cantidad" type="number" placeholder="Cantidad" required>
                <button type="button" onclick="this.parentNode.remove()">❌</button>
                <br>
            </div>
        </div>

        <button type="button" onclick="agregarFila()">+ Agregar Producto</button><br><br>
        <button type="submit">Guardar Pedido</button>
    </form>

    <br>
    <button onclick="location.href='/'">Volver a Inicio</button>
</body>
</html>
